function Game(a)local b=a.player;local c={}local d={}local e=0;local f=20;local g=true;local h=false;local i=false;local j=0;local k=128*8;local l=96-16-12;local m=30*3;local n=0;local o=0;local p=CloudSystem()local q=Enterprise()local r=Xwing()local s=AircraftSystem()local t=PegasusParade({top=0,bottom=80,left=0,right=128})local u=AlienShip()local v=30;local w=60;local x=90;local y=120;local z=5;local A=throttle(t.trigger,5)local B=throttle(q.trigger,5)local C=throttle(u.trigger,5)local D=throttle(r.trigger,5)function is_grace_period()return n<m end;function draw_stretched_sprite(E,F,G,H)local I=1+abs(H)*0.1;local J=8;local K=8;local L=J;local M=K*I;sspr(E%16*8,flr(E/16)*8,J,K,F,G,L,M)end;function game_controller()p.update()q.controller()r.controller()t.update()u.controller()if a.score>20 then if a.score%y<z then A()elseif a.score%x<z then C()elseif a.score%w<z then D()elseif a.score%v<z then B()end end;s.update()if is_grace_period()then n=n+1 end;for N in all(d)do if b.x<N.x+N.width and b.x+8>N.x and b.y<N.y+N.height and b.y+8>N.y then music(1,0,0)screen=screens.game_over;del(d,N)end end;timer_frame_counter=timer_frame_counter+1;if timer_frame_counter>=30 then timer_frame_counter=0;timer=timer+1;a.score=a.score+3 end;if btnp(4)and b.on_ground or btnp(5)and b.on_ground then sfx(62)b.dy=b.jump_strength;b.on_ground=false;o=50 end;b.dy=b.dy+b.gravity;b.y=b.y+b.dy;if b.y>104 then b.y=104;b.dy=0;b.on_ground=true end;b.oscillation=b.oscillation+0.1;if b.oscillation>2*MATH.PI then b.oscillation=b.oscillation-2*MATH.PI end;if b.on_ground then b.y=104+sin(b.oscillation)end;e=e+1;if not is_grace_period()and e>f+rnd(180)then e=0;if not a.debug_mode then sprite_obstacle=flr(rnd(12))+192;if sprite_obstacle==192 then end;add(d,{x=128,y=104,width=8,height=flr(rnd(8)+16),sprite=sprite_obstacle})end end;for N in all(d)do N.x=N.x-2;if N.x<-N.width then del(d,N)a.score=a.score+2 end end;for N in all(d)do if b.x<N.x+N.width and b.x+8>N.x and b.y<N.y+N.height and b.y+8>N.y then music(-1)a.screen=screens.game_over;del(d,N)end end;j=(j-1)%k;if j%16==0 then add(c,{x=128,y=114+rnd(8),sprite=flr(rnd(3))+82})end;if j%24==0 then end;for O in all(c)do O.x=O.x-2;if O.x<-8 then del(c,O)end end end;function game_view()rectfill(0,0,127,127,1)if a.daytime==false then spr(99,2,10)spr(98,10,10)spr(100,18,10)pal()else spr(96,10,10)pal({[0]=0,140,2,3,4,5,6,7,8,9,10,11,12,13,14,15},1)end;map(0,0,j,l,k/8,32)map(0,0,j-k,l,k/8,32)s.draw()p.draw()t.draw()rectfill(0,112-12,128,128,3)rectfill(0,112-8,128,128,0)rectfill(0,112-8,128,112-8,5)rectfill(0,112+8,128,128,3)rectfill(0,112+8,128,112+8,5)for O in all(c)do spr(O.sprite,O.x,O.y)end;q.view()u.view()r.view()local P=RIDERS[b.rider].sprite;if o<30/2 then draw_stretched_sprite(P+16,b.x,b.y,b.dy)else draw_stretched_sprite(P,b.x,b.y,b.dy)end;if b.on_ground==true then if P>=13 then timing=30 else timing=60 end;if o>=timing then o=0 else o=o+1 end end;rbp_draw_update(b,a.score)for N in all(d)do spr(N.sprite,N.x,N.y)end;print("score: "..a.score,5,122,7)print("high score: "..a.high_score,60,122,7)end;return{view=game_view,controller=game_controller}end